{
    "version": 3,
    "sources": [
        "../../../src/admin/controller/base.js"
    ],
    "names": [
        "init",
        "http",
        "__before",
        "base_path",
        "host",
        "isAjax",
        "url",
        "module",
        "controller",
        "action",
        "login_url",
        "in_array",
        "think",
        "config",
        "isLogin",
        "is_login",
        "session",
        "user",
        "loadUserMenu",
        "menu",
        "getCurrentMenu",
        "current_menu",
        "model",
        "recodeLog",
        "ip",
        "param",
        "username",
        "id",
        "curr_url",
        "locked",
        "fail",
        "redirect",
        "isEmpty",
        "isLocked",
        "loadAllMenu",
        "loadMenuByUser",
        "sortMenu",
        "current_url",
        "child",
        "forEach",
        "element",
        "children",
        "ele",
        "parent",
        "filter",
        "pid",
        "length",
        "base"
    ],
    "mappings": "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",
    "file": "../../../src/admin/controller/base.js",
    "sourcesContent": [
        "// +----------------------------------------------------------------------\r\n// | ThinkJS-RABC [ 通用权限管理系统 ]\r\n// +----------------------------------------------------------------------\r\n// | Nanjing Digital Technology Co., Ltd.\r\n// +----------------------------------------------------------------------\r\n// | Copyright (c) 2017 http://www.51-health.com All rights reserved.\r\n// +----------------------------------------------------------------------\r\n// | Author: Devlin <Devlinheart@qq.com>\r\n// +----------------------------------------------------------------------\r\n// | Create: 2017-06-20\r\n// +----------------------------------------------------------------------\r\n\r\n\r\n'use  strict'\r\n\r\nexport default class extends  think.controller.base {\r\n\r\n    init(http){\r\n        super.init(http);\r\n        this.http = http;\r\n    }\r\n    /**\r\n     * 过滤器\r\n     */\r\n    async  __before(){\r\n        this.base_path = this.http.host;\r\n        if(!this.isAjax()){\r\n            this.url = \"/\"+this.http.module+\"/\"+this.http.controller+\"/\"+this.http.action;\r\n        }\r\n        let login_url = `/${this.http.module}/${this.http.controller}/${this.http.action}`;\r\n        if(!in_array(login_url,think.config(\"login_pass_add\"))){\r\n            let is_login = await this.isLogin();\r\n            if(is_login){\r\n                let user = await this.session(\"userinfo\");\r\n                //菜单信息\r\n                this.menu = await this.loadUserMenu(user);\r\n                this.current_menu =await this.getCurrentMenu(this.menu,this.url);\r\n                //记录日志\r\n                await this.model(\"log\").recodeLog(this.ip(),this.url,this.param(),user.username,user.id);\r\n                \r\n                if(!this.isAjax()){\r\n                    user.curr_url = this.url;\r\n                    await this.session(\"userinfo\",user);\r\n                }\r\n                if(user.locked){\r\n                    if(login_url != think.config(\"lock_add\")){\r\n                        if(this.isAjax()){\r\n                            return this.fail(-2,\"已锁定\",{url:\"/admin/user/lock\"});\r\n                        }\r\n                        else{\r\n                            return this.redirect('/admin/user/lock');\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            else{\r\n                if(this.isAjax()){\r\n                    return this.fail(-2,\"用户未登录\",{url:\"/admin/user/login\"});\r\n                }\r\n                else{\r\n                    return this.redirect('/admin/user/login');\r\n                }\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * 判断用户是否登陆\r\n     */\r\n    async isLogin(){\r\n        let user= await this.session(\"userinfo\");\r\n        if(!think.isEmpty(user)){\r\n            return true;\r\n        } \r\n        else{\r\n            return false;\r\n        }\r\n    }\r\n    /**\r\n     * 判断是否锁屏\r\n     */\r\n    async isLocked(){\r\n        let user= await this.session(\"userinfo\");\r\n        if(!think.isEmpty(user)&&user.locked){\r\n            return true;\r\n        } \r\n        else{\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 加载用户菜单\r\n     * @param {*} user 当前登陆用户\r\n     */\r\n    async loadUserMenu(user){\r\n        if(!think.isEmpty(user)){\r\n            let menu = null\r\n            if(user.username == think.config(\"superuser\")){\r\n                menu = await this.model(\"menu\").loadAllMenu();\r\n            }\r\n            else{\r\n                menu = await this.model(\"menu\").loadMenuByUser(user);\r\n            }\r\n            if(!think.isEmpty(menu)){\r\n                menu = sortMenu(menu,0);\r\n            }\r\n            return menu;\r\n        }\r\n    }\r\n    /**\r\n     * 获取当前选中的菜单\r\n     */\r\n    async getCurrentMenu(menu,url){\r\n        let current_url ={};\r\n        let child = null;\r\n        menu.forEach(function(element) {\r\n            element.children.forEach(function(ele){\r\n                if(ele.url ==url ){\r\n                    child = ele;\r\n                }\r\n            });\r\n        }, this);\r\n        if(!think.isEmpty(child)){\r\n            current_url.child = child;\r\n            let parent = menu.filter(function(ele){\r\n                return ele.id==child.pid;\r\n            });\r\n            if(!think.isEmpty(parent)&&parent.length>0){\r\n                current_url.parent = parent[0];\r\n            }\r\n        }\r\n        else{\r\n            menu.filter(function(ele){\r\n                if(!think.isEmpty(ele.url)&&ele.url==url){\r\n                    current_url.parent = ele;\r\n                }\r\n            })\r\n        }\r\n        return current_url;\r\n    }\r\n}"
    ]
}